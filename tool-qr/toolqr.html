<!DOCTYPE html>

<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>CN910 - VietinBank QR</title>
  <style>
    @font-face {
      font-family: "SVN Gilroy";
      src: url("./fonts/SVN-Gilroy-Regular.otf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "SVN Gilroy";
      src: url("./fonts/SVN-Gilroy-Medium.otf") format("truetype");
      font-weight: 500;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "SVN Gilroy";
      src: url("./fonts/SVN-Gilroy-SemiBold.otf") format("truetype");
      font-weight: 600;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "SVN Gilroy";
      src: url("./fonts/SVN-Gilroy-Bold.otf") format("truetype");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "SVN Gilroy";
      src: url("./fonts/SVN-Gilroy-ExtraBold.otf") format("truetype");
      font-weight: 800;
      font-style: normal;
      font-display: swap;
    }

    * {
      box-sizing: border-box
    }

    :root {
      --brand: #0b7cc2;
      --ink: #0a2a44;
      --muted: #5a7792;
      --panel: #ffffff;
      --bg: #e9f6ff
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: "SVN Gilroy", Arial, sans-serif;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 18px
    }

    .wrap {
      width: min(1260px, 98vw);
      display: grid;
      grid-template-columns: 700px 1fr;
      gap: 18px
    }

    .card {
      position: relative;
      width: 680px;
      height: 1020px;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 18px 50px rgba(13, 63, 97, .18);
      background: #bfe8ff
    }

    .bg {
      position: absolute;
      inset: 0;
      background: url('./source/sample.png') center/cover no-repeat
    }

    .qr-box {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 200px;
      width: 380px;
      height: 380px;
      background: #fff;
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, .12);
      display: flex;
      align-items: center;
      justify-content: center
    }

    .qr-box img {
      max-width: 100%;
      max-height: 100%;
      display: block
    }

    .title {
      position: absolute;
      left: 0;
      right: 0;
      top: 660px;
      text-align: center;
      color: #134a7c;
      text-transform: uppercase;
      font-weight: 800;
      letter-spacing: .04em;
      line-height: 1.14;
      font-size: 40px;
      padding: 0 24px;
      /* ƒë·ªÉ c√≥ bi√™n wrap ƒë·∫πp */
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
    }

    .account,
    .alias {
      position: absolute;
      left: 0;
      right: 0;
      text-align: center;
      color: #134a7c;
    }

    .account {
      top: 730px;
      /* color: #134a7c; */
      font-size: 24px;
      font-weight: 400
    }

    .account b {
      color: #134a7c;
      font-size: 30px;
      font-weight: 700
    }

    .alias {
      top: 780px;
      /* color: var(--muted); */
      font-size: 20px;
      font-weight: 500;
      display: none
    }

    .alias b {
      color: #134a7c;
      font-size: 26px;
      font-weight: 700
    }

    .footer {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 55px;
      text-align: center;
      color: #355a78;
      font-size: 18px;
      line-height: 1.35;
      font-weight: 700
    }

    .panel {
      background: var(--panel);
      border-radius: 16px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, .08);
      padding: 16px;
      position: sticky;
      top: 12px;
      height: fit-content
    }

    .panel h2 {
      margin: 12px 0;
      font-size: 16px;
      border-bottom: 1px solid #e0eaf3;
      padding-bottom: 4px;
      color: #0a2a44
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px
    }

    label {
      display: block;
      font-size: 12px;
      color: #4a6783;
      margin: 10px 2px 6px
    }

    input[type="text"],
    input[type="url"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #d6e3ef;
      border-radius: 8px;
      font-size: 14px;
      outline: none
    }

    input[type="range"] {
      width: 100%
    }

    .btn {
      padding: 12px;
      border: 0;
      border-radius: 10px;
      background: var(--brand);
      color: #fff;
      font-weight: 700;
      cursor: pointer
    }

    .btn.secondary {
      background: #446b86
    }

    .btns {
      display: flex;
      gap: 10px;
      margin-top: 12px
    }

    .hint {
      font-size: 12px;
      color: #6a859e;
      margin-top: 6px
    }

    @media (max-width:1080px) {
      .wrap {
        grid-template-columns: 1fr
      }

      .card {
        margin: 0 auto
      }

      .panel {
        position: static
      }
    }

    @media print {
      body {
        background: #fff;
        padding: 0
      }

      .panel {
        display: none
      }

      .wrap {
        grid-template-columns: 1fr
      }

      .card {
        box-shadow: none;
        border-radius: 0
      }
    }
  </style>
  <script src="./js/jszip.min.js"></script>
  <script src="./js/FileSaver.min.js"></script>
  <script src="./js/xlsx.full.min.js"></script>
  <script src="./js/html2canvas.min.js"></script>
</head>

<body>
  <div class="wrap">
    <!-- PREVIEW -->
    <div class="card" id="card">
      <div class="bg" id="bg"></div>
      <div class="qr-box" id="qrBox">
        <img alt="QR" crossorigin="anonymous" id="qr" src="" />
      </div>
      <div class="title" id="title">
        <!-- S·ª≠ d·ª•ng 1 trong 2 ch·∫ø ƒë·ªô: titleText (n·∫øu c√≥) ho·∫∑c org1+org2 -->
        <div id="titleText" style="display:none;"></div>
        <div id="orgWrap">
          <div id="org1">VietinBank</div>
          <div id="org2">Chi nhanh Nam Sai Gon</div>
        </div>
      </div>
      <div class="account" id="accountLine"><span id="accountLabel">T√†i kho·∫£n</span> <b id="account">100868576472</b>
      </div>
      <div class="alias" id="aliasLine"><span id="aliasLabel">Alias </span><b id="aliasVal">ThoLC</b>
      </div>
      <div class="footer">
        <div id="f1">VietinBank - CN Nam S√†i G√≤n</div>
        <div id="f2">Ph√≤ng D·ªãch v·ª• Kh√°ch H√†ng</div>
        <div id="f3">23 Nguy·ªÖn H·ªØu Th·ªç, P. T√¢n H∆∞ng, TP HCM</div>
      </div>
    </div>
    <!-- CONTROL PANEL -->
    <!-- <form class="panel" id="multi_form" onsubmit="return false;">
      
    </form> -->
    <form class="panel" id="form" onsubmit="return false;">
      <div
        style="display: flex; justify-content: space-between; width: 100%; gap: 16px; margin-top: 10px; border: 1px solid #e5e7eb; padding: 8px; border-radius: 10px; background: white;">
        <div
          style="display: flex; flex-direction: column; gap: 4px; background-color: #f3f4f6; padding: 12px; border-radius: 8px; flex: 1;">
          <div style="font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
            <span>üîπ</span>QR l·∫ª
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn" id="applyBtn" type="button">Load m√£ QR</button>
              <button class="btn secondary" id="exportBtn" type="button">T·∫£i PNG</button>
            </div>
        </div>
        <div
          style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end; background-color: #f3f4f6; padding: 12px; border-radius: 8px; flex: 1;">
          <div
            style="font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; text-align: right; justify-content: flex-end;">
            <span>üì¶</span>QR theo l√¥
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn secondary" id="openExcel" type="button">Load file Excel</button>
            <button class="btn" id="multiExport" type="button">Xu·∫•t QR</button>
          </div>
        </div>
      </div>
      <h2>VietinBank Nam S√†i G√≤n - T·∫°o QR form A6</h2>
      <label>·∫¢nh n·ªÅn (./source)</label>
      <input accept="image/*" id="i_bg_file" style="margin-top:10px" type="file" />
      <!-- <label>·∫¢nh QR (URL ho·∫∑c ./source)</label> -->
      <input id="i_qr" style="display: none;" type="text" value="./source/qr.png" />
      <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
        <input checked="" disabled="" id="i_autoQr" type="checkbox" />
        <label for="i_autoQr" style="margin:0">T·ª± ƒë·ªông t·∫°o QR theo STK/Alias (VietQR)</label>
      </div>
      <h2>QR Box</h2>
      <label>V·ªã tr√≠ QR t·ª´ tr√™n (px)</label><input id="i_qrTop" max="960" min="100" type="range" value="200" />
      <label>K√≠ch th∆∞·ªõc QR (px)</label><input id="i_qrSize" max="480" min="220" type="range" value="380" />
      <h2>Ti√™u ƒë·ªÅ</h2>
      <label>Ng∆∞·ªùi th·ª• h∆∞·ªüng (t·ª± xu·ªëng d√≤ng n·∫øu d√†i)</label>
      <textarea id="i_titleText"
        placeholder="Nh·∫≠p T√™n ng∆∞·ªùi th·ª• h∆∞·ªüng (n·∫øu ƒë·ªÉ tr·ªëng s·∫Ω d√πng 2 d√≤ng b√™n d∆∞·ªõi)">VIETINBANK NAM S√ÄI G√íN</textarea>
      <div class="row">
        <div>
          <label>D√≤ng 1</label>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <input id="i_org1" type="text" />
            <!-- <input id="i_org1Color" style="width: 24px; height: 24px; padding: 0; border: none; cursor: pointer;" type="color" value="#134a7c" /> -->
          </div>
        </div>
        <div>
          <label>D√≤ng 2</label>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <input id="i_org2" type="text" />
            <input id="i_org2Color" style="width: 24px; height: 24px; padding: 0; border: none; cursor: pointer;"
              type="color" value="#134a7c" />
          </div>
        </div>
      </div>
      <label>K√≠ch th∆∞·ªõc Ng∆∞·ªùi th·ª• h∆∞·ªüng (px)</label><input id="i_titleSize" max="64" min="20" style="width: 60px;"
        type="number" value="40" />
      <label>T·ªça ƒë·ªô Ng∆∞·ªùi th·ª• h∆∞·ªüng (px t·ª´ tr√™n)</label><input id="i_titleTop" max="960" min="60" type="range"
        value="670" />
      <h2>T√†i kho·∫£n</h2>
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
        <!-- <input id="i_accountLabel" style="width: 120px; font-size: 12px;" type="text" value="T√ÄI KHO·∫¢N"/> -->
        <input id="i_account" style="flex: 1;" type="text" value="100868576472" />
        <input id="i_accountColor" style="width: 30px; height: 30px; padding: 0; border: none; cursor: pointer;"
          type="color" value="#134a7c" />
        <input id="i_accountFontSize" max="64" min="20" style="width: 60px;" type="number" value="30" />
        <input checked="checked" id="i_accountVisible" title="·∫®n T√†i kho·∫£n" type="checkbox" /> <label>Show SoTK</label>
      </div>
      <label>T·ªça ƒë·ªô t√†i kho·∫£n (px t·ª´ tr√™n)</label><input id="i_accountTop" max="960" min="60" type="range"
        value="730" />
      <h2>Alias</h2>
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
        <!-- <input id="i_aliasLabel" style="width: 120px; font-size: 12px;" type="text" value="ALIAS" /> -->
        <input id="i_alias" style="flex: 1;" type="text" value="ThoLC" />
        <input id="i_aliasColor" style="width: 30px; height: 30px; padding: 0; border: none; cursor: pointer;"
          type="color" value="#134a7c" />
        <input id="i_aliasFontSize" max="64" min="10" style="width: 60px;" type="number" value="26" />
        <input id="i_aliasVisible" title="·∫®n Alias" type="checkbox" /><label>Show Alias</label>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <!-- <input id="i_aliasVisible" type="checkbox"/>
<label for="i_aliasVisible" style="margin:0">Hi·ªÉn th·ªã Alias</label> -->
      </div>
      <label>T·ªça ƒë·ªô Alias (px t·ª´ tr√™n)</label><input id="i_aliasTop" max="980" min="50" type="range" value="780" />
      <h2>Footer</h2>
      <div style="display:flex;align-items:center;gap:10px">
        <input checked="True" id="i_footerVisible" type="checkbox" />
        <label for="i_footerVisible" style="margin:0">Show Footer</label>
      </div>
      <div class="row">
        <div>
          <label>D√≤ng 1</label>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <input id="i_f1" type="text" value="VietinBank - CN Nam S√†i G√≤n" />
            <!-- <input id="i_f1Color" style="width: 24px; height: 24px; padding: 0; border: none; cursor: pointer;"type="color" value="#134a7c" /> -->
          </div>
        </div>
        <div>
          <label>D√≤ng 2</label>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <input id="i_f2" type="text" value="Ph√≤ng D·ªãch v·ª• Kh√°ch H√†ng" />
            <!-- <input id="i_f2Color" style="width: 24px; height: 24px; padding: 0; border: none; cursor: pointer;" type="color"  value="#134a7c" /> -->
          </div>
        </div>
        <div>
          <label>D√≤ng 3</label>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <input id="i_f3" type="text" value="23 Nguy·ªÖn H·ªØu Th·ªç, P. T√¢n H∆∞ng, TP HCM" />
            <input id="i_f3Color" style="width: 24px; height: 24px; padding: 0; border: none; cursor: pointer;"
              type="color" value="#134a7c" />
          </div>
        </div>
      </div>
    </form>
  </div>
  <!-- <div class="hint">ƒê·∫∑t ·∫£nh trong <code>./source</code>. N·∫øu d√πng ·∫£nh t·ª´ internet, xu·∫•t PNG c√≥ th·ªÉ l·ªói do CORS (tainted canvas).</div> -->
  <!-- OFFLINE JS -->
  <input accept=".xlsx" id="excelFileInput" style="display:none" type="file" />
  <script type="module">// ===== Utils =====
    let hasApplied = false;
    const el = id => document.getElementById(id);
    const setText = (id, v) => { if (v != null) el(id).textContent = v; };
    const setBg = url => { if (url) el('bg').style.backgroundImage = `url('${url}')`; };
    const setSrc = url => { if (url) el('qr').src = url; };

    function qrUrlFromAccount(acc) {
      const clean = (acc || '').replace(/\\D/g, ''); // ch·ªâ gi·ªØ s·ªë
      if (!clean) return '';
      return `https://img.vietqr.io/image/970415-${clean}-QY3QZ1v.jpg`;
    }

    function useTitleTextIfAny() {
      const t = el('i_titleText').value.trim();
      const has = t.length > 0;
      el('titleText').style.display = has ? 'block' : 'none';
      el('orgWrap').style.display = has ? 'none' : 'block';
      if (has) {
        // uppercase & wrap (CSS ƒë√£ lo wrap)
        el('titleText').textContent = t.toUpperCase();
      }
    }

    // ===== Apply (button) =====
    el('applyBtn').addEventListener('click', () => {
      hasApplied = true;
      // Title switching
      useTitleTextIfAny();

      const acc = el('i_account').value.trim();
      const autoQR = el('i_autoQr').checked;
      const qrVal = autoQR ? qrUrlFromAccount(acc) : el('i_qr').value;
      if (autoQR && qrVal) { el('i_qr').value = qrVal; }

      // text
      setText('org1', el('i_org1').value.toUpperCase());
      setText('org2', el('i_org2').value.toUpperCase());
      setText('account', acc);
      setText('aliasVal', el('i_alias').value);

      // images
      // setBg removed - using file base64 only
      setSrc(qrVal);

      // layout
      el('title').style.top = el('i_titleTop').value + 'px';
      el('title').style.fontSize = el('i_titleSize').value + 'px';
      el('qrBox').style.top = el('i_qrTop').value + 'px';
      el('qrBox').style.width = el('i_qrSize').value + 'px';
      el('qrBox').style.height = el('i_qrSize').value + 'px';
      el('accountLine').style.top = el('i_accountTop').value + 'px';
      el('aliasLine').style.top = el('i_aliasTop').value + 'px';
      el('aliasLine').style.display = el('i_aliasVisible').checked ? 'block' : 'none';
    });

    // ===== Live updates =====
    // Background & QR URL fields
    el('i_qr').addEventListener('input', e => setSrc(e.target.value));

    // Title live
    el('i_titleText').addEventListener('input', () => useTitleTextIfAny());
    el('i_org1').addEventListener('input', e => setText('org1', e.target.value.toUpperCase()));
    el('i_org2').addEventListener('input', e => setText('org2', e.target.value.toUpperCase()));
    el('i_titleTop').addEventListener('input', e => el('title').style.top = e.target.value + 'px');
    el('i_titleSize').addEventListener('input', e => el('title').style.fontSize = e.target.value + 'px');

    // QR live
    el('i_qrTop').addEventListener('input', e => el('qrBox').style.top = e.target.value + 'px');
    el('i_qrSize').addEventListener('input', e => {
      el('qrBox').style.width = e.target.value + 'px';
      el('qrBox').style.height = e.target.value + 'px';
    });

    // Account live + auto VietQR
    // el('i_account').addEventListener('input', e=>{
    //   const acc = e.target.value.trim();
    //   setText('account', acc);
    //   if(el('i_autoQr').checked){
    //     const url = qrUrlFromAccount(acc);
    //     if(url){ setSrc(url); el('i_qr').value = url; }
    //   }
    // });
    el('i_accountTop').addEventListener('input', e => el('accountLine').style.top = e.target.value + 'px');

    // Alias live
    el('i_alias').addEventListener('input', e => setText('aliasVal', e.target.value));
    el('i_aliasTop').addEventListener('input', e => el('aliasLine').style.top = e.target.value + 'px');
    el('i_aliasVisible').addEventListener('change', e => el('aliasLine').style.display = e.target.checked ? 'block' : 'none');

    // ===== Export PNG (avoid tainted canvas) =====
    function isLocalPath(url) {
      if (!url) return true;
      const u = String(url).trim();
      return !u.startsWith('http');
    }

    el('exportBtn').addEventListener('click', () => {
      if (!hasApplied) { alert('‚ö†Ô∏è Vui l√≤ng Load m√£ QR tr∆∞·ªõc khi Xu·∫•t QR!'); return; }
      const bgInput = document.getElementById('i_bg_file');
      if (!bgInput || !bgInput.files || bgInput.files.length === 0) {
        alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn ·∫£nh n·ªÅn t·ª´ m√°y tr∆∞·ªõc khi Xu·∫•t QR.");
        return;
      }
      // Ki·ªÉm tra ngu·ªìn ·∫£nh ƒë·ªÉ tr√°nh tainted canvas
      const bgStyle = getComputedStyle(el('bg')).backgroundImage;
      const bgUrl = bgStyle && bgStyle.startsWith('url(') ? bgStyle.slice(5, -2) : '';
      const qrUrl = el('qr').getAttribute('src') || '';

      if (!isLocalPath(bgUrl) || !isLocalPath(qrUrl)) {
        alert(
          '‚ö†Ô∏è ƒê·ªÉ xu·∫•t PNG, vui l√≤ng ch·ªçn ·∫¢nh n·ªÅn!'
        );
        return;
      }

      html2canvas(el('card'), {
        backgroundColor: null,
        useCORS: true,
        allowTaint: false,
        scale: 2
      }).then(canvas => {
        const timestamp = new Date().toISOString().replace(/[-:.TZ]/g, "").slice(0, 14);
        const acc = document.getElementById('i_account').value.trim();
        const file_name = `Result-QR-${acc}-${timestamp}`
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = `${file_name || 'output'}.png`;
        a.click();
      }).catch(err => {
        console.error(err);
        alert('‚ö†Ô∏è Kh√¥ng th·ªÉ Xu·∫•t QR. Vui l√≤ng ch·ªçn ·∫¢nh n·ªÅn!.');
      });
    });

    // Kh·ªüi t·∫°o tr·∫°ng th√°i hi·ªÉn th·ªã title (org vs titleText)
    useTitleTextIfAny();

    document.getElementById('applyBtn').addEventListener('click', async () => {
      useTitleTextIfAny();

      const acc = document.getElementById('i_account').value.trim();
      const autoQR = document.getElementById('i_autoQr').checked;
      const qrVal = qrUrlFromAccount(acc);

      if (autoQR && qrVal) {
        const timestamp = new Date().toISOString().replace(/[-:.TZ]/g, "").slice(0, 14);
        const fileName = `TempQR-${acc}-${timestamp}.png`;

        try {
          const blob = await fetch(qrVal).then(r => r.blob());
          const reader = new FileReader();
          reader.onload = function () {
            const base64 = reader.result;

            const img = document.getElementById('qr');
            img.setAttribute('crossorigin', 'anonymous');
            img.src = base64;
          };
          reader.readAsDataURL(blob);
        } catch (err) {
          alert('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i ·∫£nh QR. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c th·ª≠ l·∫°i sau.');
          console.error(err);
        }
      }

      setText('org1', document.getElementById('i_org1').value.toUpperCase());
      setText('org2', document.getElementById('i_org2').value.toUpperCase());
      setText('account', acc);
      setText('aliasVal', document.getElementById('i_alias').value);
      setSrc(document.getElementById('qr').src);
      document.getElementById('title').style.top = document.getElementById('i_titleTop').value + 'px';
      document.getElementById('title').style.fontSize = document.getElementById('i_titleSize').value + 'px';
      document.getElementById('qrBox').style.top = document.getElementById('i_qrTop').value + 'px';
      document.getElementById('qrBox').style.width = document.getElementById('i_qrSize').value + 'px';
      document.getElementById('qrBox').style.height = document.getElementById('i_qrSize').value + 'px';
      document.getElementById('accountLine').style.top = document.getElementById('i_accountTop').value + 'px';
      document.getElementById('aliasLine').style.top = document.getElementById('i_aliasTop').value + 'px';
      document.getElementById('aliasLine').style.display = document.getElementById('i_aliasVisible').checked ? 'block' : 'none';
    });

    el('i_accountFontSize').addEventListener('input', e => {
      el('account').style.fontSize = e.target.value + 'px';
    });
    el('i_aliasFontSize').addEventListener('input', e => {
      el('aliasVal').style.fontSize = e.target.value + 'px';
      el('aliasLabel').style.fontSize = e.target.value + 'px';
    });
    el('i_f1').addEventListener('input', e => setText('f1', e.target.value));
    el('i_f2').addEventListener('input', e => setText('f2', e.target.value));
    el('i_f3').addEventListener('input', e => setText('f3', e.target.value));
    el('i_footerVisible').addEventListener('change', e => {
      document.querySelector('.footer').style.display = e.target.checked ? 'block' : 'none';
    });
    window.addEventListener("DOMContentLoaded", () => {
      const inputFile = document.getElementById('i_bg_file');
      if (!inputFile) return;

      inputFile.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          const dataUrl = event.target.result;
          const bg = document.getElementById("bg");
          bg.style.backgroundImage = `url('${dataUrl}')`;
        };
        reader.readAsDataURL(file);
      });
    });

    el('i_accountColor').addEventListener('input', e => {
      el('account').style.color = e.target.value;
      el('accountLabel').style.color = e.target.value;
    });

    el('i_aliasColor').addEventListener('input', e => {
      el('aliasVal').style.color = e.target.value;
      el('aliasLabel').style.color = e.target.value;
    });

    el('i_org2Color').addEventListener('input', e => {
      el('org2').style.color = e.target.value;
      el('org1').style.color = e.target.value;
      el('titleText').style.color = e.target.value;

    });
    el('i_f3Color').addEventListener('input', e => {
      el('f1').style.color = e.target.value;
      el('f2').style.color = e.target.value;
      el('f3').style.color = e.target.value;
    });


    el('i_accountVisible').addEventListener('change', e => {
      el('accountLine').style.display = e.target.checked ? 'block' : 'none';
    });
    el('i_aliasVisible').addEventListener('change', e => {
      el('aliasLine').style.display = e.target.checked ? 'block' : 'none';
    });


    let excelData = [];

    document.getElementById('openExcel').addEventListener('click', () => {
      document.getElementById('excelFileInput').click();
    });

    document.getElementById('excelFileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      excelData = XLSX.utils.sheet_to_json(sheet);
      alert('ƒê√£ load ' + excelData.length + ' d√≤ng d·ªØ li·ªáu t·ª´ Excel.');
    });

    document.getElementById('multiExport').addEventListener('click', async () => {
      const errorLogs = [];
      const bgInput = document.getElementById('i_bg_file');
      if (!bgInput || !bgInput.files || bgInput.files.length === 0) {
        alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn ·∫£nh n·ªÅn t·ª´ m√°y tr∆∞·ªõc khi Xu·∫•t QR.");
        return;
      }
      if (!excelData.length) {
        alert('‚ö†Ô∏è Vui l√≤ng Load file Excel tr∆∞·ªõc.');
        return;
      }


      const zip = new window.JSZip();
      el('exportProgressOverlay').style.display = 'block';
      el('progressTotal').innerText = excelData.length;
      for (let i = 0; i < excelData.length; i++) {

        el('progressCounter').innerText = i + 1;
        const row = excelData[i];

        document.getElementById('i_account').value = row.account || "";
        document.getElementById('i_alias').value = row.aliasVal || "";
        document.getElementById('i_org1').value = row.org1 || "";
        document.getElementById('i_org2').value = row.org2 || "";
        document.getElementById('i_titleText').value = row.titleText || "";

        // C·∫≠p nh·∫≠t alias checkbox
        document.getElementById('i_aliasVisible').checked = !!row.aliasVal;

        // Chuy·ªÉn gi·ªØa titleText v√† org1/org2
        if (row.titleText && row.titleText.trim().length > 0) {
          document.getElementById('titleText').style.display = 'block';
          document.getElementById('orgWrap').style.display = 'none';
        } else {
          document.getElementById('titleText').style.display = 'none';
          document.getElementById('orgWrap').style.display = 'block';
        }

        // G·ªçi n√∫t "Apply" ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
        document.getElementById('applyBtn').click();

        // ƒê·ª£i 500ms ƒë·ªÉ ·∫£nh QR load ‚Üí sau ƒë√≥ export
        // await new Promise(r => setTimeout(r, 800));

        const qrImg = document.getElementById('qr');
        let retryCount = 0;
        while ((!qrImg.complete || qrImg.naturalWidth === 0) && retryCount < 2) {
          console.warn("‚ö†Ô∏è L·ªói khi load QR. ƒêang th·ª≠ l·∫°i...");
          await new Promise(r => setTimeout(r, 500));
          retryCount++;
        }
        if (!qrImg.complete || qrImg.naturalWidth === 0) {
          errorLogs.push(`‚ùå D√≤ng ${i + 1} (${row.account || 'N/A'}): QR kh√¥ng load ƒë∆∞·ª£c sau 2 l·∫ßn th·ª≠.`);
          continue;
        }

        const canvas = await html2canvas(document.getElementById('card'), {
          useCORS: true,
          backgroundColor: null,
          scale: 2
        });
        const imgData = canvas.toDataURL("image/png");
        const fileName = `QR-${row.account || 'unk'}-${Date.now()}.png`;
        zip.file(fileName, imgData.split(',')[1], { base64: true });


        // ƒê·ª£i 1.5s ƒë·ªÉ export xong r·ªìi m·ªõi sang d√≤ng k·∫ø ti·∫øp
        await new Promise(r => setTimeout(r, 1000));
      }


      zip.generateAsync({ type: 'blob' }).then(function (content) {

        if (errorLogs.length > 0) {
          zip.file("error_log.txt", errorLogs.join("\n"));
        }

        alert('‚úÖ Done. Vui l√≤ng ki·ªÉm tra k·∫øt qu·∫£!');
        const timestamp = new Date().toISOString().replace(/[-:.TZ]/g, "").slice(0, 14);
        saveAs(content, `Multi_QR-${timestamp}.zip`);
        el('exportProgressOverlay').style.display = 'none';
      });

    });


    function convertImageUrlToBase64(url, callback) {
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = function () {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        const dataURL = canvas.toDataURL("image/png");
        callback(dataURL);
      };
      img.onerror = function () {
        alert("Kh√¥ng th·ªÉ t·∫£i ·∫£nh t·ª´ URL: " + url);
      };
      img.src = url;
    }

    el('i_bg_file').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const dataUrl = event.target.result;
        const bg = document.getElementById("bg");
        bg.style.backgroundImage = `url('${dataUrl}')`;
      };
      reader.readAsDataURL(file);
    });</script>
  <div id="exportProgressOverlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4); z-index:9999;">
    <div
      style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px 40px; border-radius:8px; font-size:18px; font-weight:bold;">
      ƒêang xu·∫•t: <span id="progressCounter">0</span>/<span id="progressTotal">0</span>
    </div>
  </div>
</body>

</html>